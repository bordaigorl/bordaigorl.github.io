"use strict";var Channel=function(){var t={};function e(n){if(!(this instanceof e))return new e(n);this.name=n,t[n]||(t[n]=0),this.unique=t[n],t[n]++}return e.prototype.toPiCalc=function(){return this.name+"_"+this.unique},e.prototype.is=function(n){return this===n},e.prototype.toString=function(){return this.name+"#"+this.unique},e}(),ProcCall=function(){var e=0;function i(n,t){if(!(this instanceof i))return new i(n,t);this.proc_name=n,this.args=t||[],this.unique=e++}return i.prototype.toPiCalc=function(){return this.proc_name+"["+this.args.map(function(n){return n.toPiCalc()}).join(",")+"]"},i}(),Action=function(){function n(){if(!(this instanceof n))return new n}return n}(),Tau=function(){function t(n){if(!(this instanceof t))return new t(n);this.continuation=n}return((t.prototype=new Action).constructor=t).prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return"\u03c4..."},t}(),Receive=function(){function e(n,t){if(!(this instanceof e))return new e(n,t);this.channel=n,this.continuation=t||function(){},this.arity=t.length}return((e.prototype=new Action).constructor=e).prototype.fire=function(n){return this.continuation instanceof Function?this.continuation.apply(null,n):void 0},e.prototype.toPiCalc=function(){for(var n=[],t=0;t<this.arity;t++)n.push("_");return this.channel.toPiCalc()+"?("+n.join(",")+")..."},e}(),Send=function(){function i(n,t,e){if(!(this instanceof i))return new i(n,t,e);this.channel=n,this.args=t||[],this.arity=this.args.length,this.continuation=e}return((i.prototype=new Action).constructor=i).prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},i.prototype.toPiCalc=function(){return this.channel.toPiCalc()+"!("+this.args.map(function(n){return n.toPiCalc()}).join(",")+")..."},i}(),Alt=function(){function t(n){if(!(this instanceof t))return new t(n);this.alts=n||[]}return t.prototype.enabled_on=function(n,t){return 0<this.waiting_on(n).length},t.prototype.waiting_on=function(n,t){return this.receiving_on(n).concat(this.sending_on(n))},t.prototype.receiving_on=function(e,i){return this.alts.filter(function(n){var t;return n instanceof Receive&&(t=null==i||n.arity==i,n.channel.is(e)&&t)})},t.prototype.sending_on=function(e,i){return this.alts.filter(function(n){var t;return n instanceof Send&&(t=null==i||n.arity==i,n.channel.is(e)&&t)})},t.prototype.taus=function(){return this.alts.filter(function(n){return n instanceof Tau})},t.prototype.toPiCalc=function(){return"("+this.alts.map(function(n){return n.toPiCalc()}).join(" + ")+")"},t}(),Zero=void 0,PiDefs=function(){function t(n){if(!(this instanceof t))return new t(n);this.defs=n}return t.prototype.unfold=function(n){var t;return n.proc_name in this.defs?(t=this.defs[n.proc_name]).apply(t,n.args):Zero},t}(),Config=function(){function e(n,t){if(!(this instanceof e))return new e(n,t);this.defs=n,this.names_index={},this.init=t,this.nodes=[],this.procsIndex=0,this.epoch=0,this.links=[],this.mergeCalls(t,{x:0,y:0}),this.recomputeLinks()}function o(n){var t=60;return n+60*Math.random()-30}function s(n,t){if(null!=n&&("x"in n&&"y"in n))return null!=t&&"x"in t&&"y"in t?{x:(n.x+t.x)/2,y:(n.y+t.y)/2}:{x:n.x,y:n.y}}function a(n){for(var t=n.length,e,i;t;)i=Math.floor(Math.random()*t--),e=n[t],n[t]=n[i],n[i]=e}e.prototype.mergeCalls=function(n,t){var e=[],i=[],r=this;return null==n?{names:[],procs:[]}:(t=t||{x:0,y:0},n.forEach(function(n){var n;n&&(n.args.forEach(function(n){n in r.names_index||(r.names_index[n]={refCount:0,age:0},null!=t&&(n.x=o(t.x),n.y=o(t.y)),e.push(n)),r.names_index[n].refCount++}),n={call:n,body:r.defs.unfold(n),age:r.epoch},null!=t&&(n.x=o(t.x),n.y=o(t.y)),i.push(n))}),this.nodes.unshift.apply(this.nodes,e),this.nodes.push.apply(this.nodes,i),this.procsIndex+=e.length,{names:e,procs:i})},e.prototype.addCalls=function(n){"string"==typeof n&&(n=n.split("|"));for(var t,e=[],i=0;i<n.length;i++)try{for(var r=n[i].trim().split("["),o=r[0],s=r[1].split("]")[0].split(",").map(function(n){return n.trim()}),a=this.getNames(),c=0;c<s.length;c++){var u=a.find(function(n){return n.toPiCalc()==s[c]});(u=u||e.find(function(n){return n.name==s[c]}))?s[c]=u:(s[c]=Channel(s[c]),e.push(s[c]))}n[i]=ProcCall(o,s)}catch(n){return console.log(n),!1}return this.mergeCalls(n,t),this.recomputeLinks(),!0},e.prototype.gcNames=function(){for(var n in this.names_index)this.names_index[n].refCount<=0&&delete this.names_index[n];for(var t=0;t<this.procsIndex;)this.nodes[t]in this.names_index?t++:(this.nodes.splice(t,1),this.procsIndex--)},e.prototype.redexes=function(){for(var t=this.procsIndex,n=[],e,n;t<this.nodes.length;){this.nodes[t].body&&(e=this.nodes[t],n=n.concat(e.body.taus().map(function(n){return{type:"tau",index:t,action:n,process:e}}))),t++}for(var i=[],r=0;r<this.procsIndex;){for(var o=[],s=[],t=this.procsIndex,e,a,c;t<this.nodes.length;){this.nodes[t].body&&(a=(e=this.nodes[t]).body.receiving_on(this.nodes[r]),c=e.body.sending_on(this.nodes[r]),a.forEach(function(n){s.push({index:t,action:n,process:e})}),c.forEach(function(n){o.push({index:t,action:n,process:e})})),t++}for(var u=0,h=!1;u<o.length;){for(var l=0;l<s.length;){var f=o[u],d=s[l];f.index!=d.index&&f.action.arity==d.action.arity&&(i.push({type:"comm",sender:f,receiver:d}),h=!0),l++}u++}h?this.names_index[this.nodes[r]].age++:this.names_index[this.nodes[r]].age=0,r++}return n.concat(i)};var i=function(o){return{pick:function(n){a(n);for(var t=o.epoch+1,e,i=n.length-1;0<=i;i--){var r,r="tau"==n[i].type?o.nodes[n[i].index].age:Math.min(o.nodes[n[i].sender.index].age,o.nodes[n[i].receiver.index].age);r<=t&&(t=r,e=i)}return null!=e?n[e]:void 0}}};return e.prototype.next=function(n){null==n&&(n=i(this));var t=this.redexes();if(t.length<=0)return!1;var n=n.pick(t);return null!=n&&(this.makeReact(n),!0)},e.prototype.makeReact=function(n){var t,e,t,e,i,r,n;return"tau"==n.type?(t=s(this.nodes[n.index]),e=n.action.fire(),this.removeProc(n.index),this.mergeCalls(e,t)):(t=s(this.nodes[n.sender.index],this.nodes[n.receiver.index]),e=n.sender.action.fire(),i=n.receiver.action.fire(n.sender.action.args),r=n.sender.index,n=n.receiver.index,this.removeProc(n<r?r:n),this.removeProc(n<r?n:r),this.mergeCalls(e,t),this.mergeCalls(i,t)),this.gcNames(),this.recomputeLinks(),this.epoch++,this},e.prototype.removeProc=function(n){if(n>=this.nodes.length||n<this.procsIndex)return!1;var t=this.names_index;return this.nodes[n].call.args.forEach(function(n){t[n].refCount--}),this.nodes.splice(n,1),!0},e.prototype.getNames=function(){return this.nodes.slice(0,this.procsIndex)},e.prototype.getProcs=function(){return this.nodes.slice(this.procsIndex)},e.prototype.recomputeLinks=function(){var t=this.links;t.splice(0,this.links.length);for(var n=this.procsIndex;n<this.nodes.length;n++){var e=this.nodes[n];e.call.args.forEach(function(n){t.push({source:e,target:n})})}},e.prototype.toPiCalc=function(){var n="\u03bd";return n=(n+=this.getNames().map(function(n){return n.toPiCalc()}).join(",")+". ")+this.getProcs().map(function(n){return n.call.toPiCalc()}).join(" | ")},e}(),PiCalcSimulation=function(){var y=d3.scale.category20(),x={nameSize:5,procWidth:18,procHeight:12},n=/^(.*)_(\d*)$/;function C(n,t,i,r){if(!(this instanceof C))return new C(n,t,i,r);var e=t.defs,t=t.init,o=Config(e,t),s;for(s in this.q=o,r=r||{},x)x.hasOwnProperty(s)&&!r.hasOwnProperty(s)&&(r[s]=x[s]);this.options=r;var a={},c=0,u;function h(n){return a[n]||(c++,a[n]=y(c)),a[n]}for(u in e.defs)h(u);i.nodes(o.nodes).links(o.links).start(),this.layout=i;var l=n,f=((n=n.append("g")).append("g").attr("id","links"),n.append("g").attr("id","nodes"),n.append("g").attr("id","labels"),n.select("#links").selectAll(".link")),d=n.select("#nodes").selectAll(".node .name"),p=n.select("#nodes").selectAll(".node .seq");function g(n){d3.event.altKey&&d3.select(this).classed("fixed",n.fixed=!n.fixed)}function m(n){d3.select(this).classed("fixed",n.fixed=!0)}this.legend=function(){var n=[],t;for(t in a)n.push({name:t,color:a[t]});return n},this.update=function(){f=f.data(o.links),d=d.data(o.getNames(),function(n){return n.toString()}),p=p.data(o.getProcs(),function(n){return n.call.unique});var n=i.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}),t=(f.exit().remove(),f.enter().append("line").attr("class","link"),d.exit().remove(),d.classed("fixed",function(n){return n.fixed}),d.enter().append("circle").classed({node:!0,name:!0}).attr("r",r.nameSize).attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}).on("click",g).call(n),r.procWidth/2),e=r.procHeight/2;p.exit().remove(),p.enter().append("rect").attr("class","node seq").attr("width",r.procWidth).attr("height",r.procHeight).attr("x",function(n){return n.color=h(n.call.proc_name),n.x-t}).attr("y",function(n){return n.y-e}).style("fill",function(n){return n.color}).on("click",function(n){console.info(n.call.toPiCalc(),n.x,n.y)}).on("click",g).call(n),i.start()},this.update();var v=function(){var t=r.procWidth/2,e=r.procHeight/2;f.attr("x1",function(n){return n.source.x}).attr("y1",function(n){return n.source.y}).attr("x2",function(n){return n.target.x}).attr("y2",function(n){return n.target.y}),d.attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}),p.attr("x",function(n){return n.x-t}).attr("y",function(n){return n.y-e})};i.on("tick",v),this.realtime=function(n){i.on("tick",n?v:null)}}return C.prototype.next=function(n){return!!this.q.next(n)&&(this.update(),!0)},C}();$(function(){var e,i,t,n,r,o=function(){for(var n=[],t=0;t<20;t++){var e=new Channel("r"),i;n.push(ProcCall("S",[e]));for(var i=1+2*Math.random(),r=0;r<i;r++)n.push(ProcCall("C",[e,new Channel("m")]));i=2*Math.random()-1;for(var r=0;r<i;r++){var o=new Channel("m");n.push(ProcCall("Q",[e,o])),n.push(ProcCall("C1",[e,o]))}i=2*Math.random()-1;for(var r=0;r<i;r++){var o=new Channel("m"),s=new Channel("d");n.push(ProcCall("C1",[e,o])),n.push(ProcCall("A",[o,s]))}}return{defs:PiDefs({S:function(e){return Alt([Receive(e,function(n){var t=new Channel("d");return[ProcCall("A",[n,t]),ProcCall("S",[e])]})])},E:function(){return Alt([])},C:function(n,t){return Alt([Tau(function(){return[ProcCall("Q",[n,t]),ProcCall("C1",[n,t])]})])},C1:function(t,e){return Alt([Receive(e,function(n){return[ProcCall("C",[t,e])]})])},Q:function(n,t){return Alt([Send(n,[t])])},A:function(n,t){return Alt([Send(n,[t])])}}),init:n}}();function s(){var n=$("#homedrawing svg").parent().innerWidth(),t=$("#homedrawing svg").parent().innerHeight();$("#homedrawing svg").height(t).width(n).attr("width",n).attr("height",t),e.select("g").attr("transform","translate("+n/2+",150)scale(.5,.5)"),i.size([n,t]).resume()}$("#homedrawing .showoff").append('<svg id="graph"></svg>'),$("#homedrawing .showoff #graph").hide(),e=d3.select("#homedrawing .showoff").select("#graph"),d3.select("#homedrawing .showoff").attr("title","Drag me!"),i=d3.layout.force().charge(-400).linkDistance(30).friction(.7),(t=PiCalcSimulation(e,o,i)).delay=500,t.loop=void 0,window.force=i,window.sim=t,$(window).resize(s);var a={pick:function(n){return n[Math.floor(Math.random()*n.length)]}};function c(){t.q.next(a),t.q.next(a),t.q.next(a),t.q.next(a),t.next(a)}t.realtime(!1),setTimeout(function(){s(),i.start(),t.update();for(var n=200;0<n;--n)i.tick();t.realtime(!0),t.next(a),$("#homedrawing .showoff #graph").fadeIn(),$("#homedrawing .showoff img").fadeOut({duration:600,complete:function(){$("#homedrawing .showoff img").remove()}})},10),n=void 0,$(".explain .ctrl").click(function(){void 0===n?(n=setInterval(function(){c()},7e3),$(this).removeClass("fa-play").addClass("fa-pause")):(clearInterval(n),n=void 0,$(this).removeClass("fa-pause").addClass("fa-play"))}).click()});