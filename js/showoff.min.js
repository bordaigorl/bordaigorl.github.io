"use strict";var Channel=function(){var n={};function t(e){if(!(this instanceof t)){return new t(e)}this.name=e;if(!n[e]){n[e]=0}this.unique=n[e];n[e]++}t.prototype.toPiCalc=function(){return this.name+"_"+this.unique};t.prototype.is=function(n){return this===n};t.prototype.toString=function(){return this.name+"#"+this.unique};return t}();var ProcCall=function(){var n=0;function t(e,i){if(!(this instanceof t)){return new t(e,i)}this.proc_name=e;this.args=i||[];this.unique=n++}t.prototype.toPiCalc=function(){return this.proc_name+"["+this.args.map(function(n){return n.toPiCalc()}).join(",")+"]"};return t}();var Action=function(){function n(){if(!(this instanceof n)){return new n}}return n}();var Tau=function(){n.prototype=new Action;n.prototype.constructor=n;function n(t){if(!(this instanceof n)){return new n(t)}this.continuation=t}n.prototype.fire=function(){if(this.continuation instanceof Function)return this.continuation();else return undefined};n.prototype.toPiCalc=function(){return"τ..."};return n}();var Receive=function(){n.prototype=new Action;n.prototype.constructor=n;function n(t,e){if(!(this instanceof n)){return new n(t,e)}this.channel=t;this.continuation=e||function(){};this.arity=e.length}n.prototype.fire=function(n){if(this.continuation instanceof Function)return this.continuation.apply(null,n);else return undefined};n.prototype.toPiCalc=function(){var n=[];for(var t=0;t<this.arity;t++){n.push("_")}return this.channel.toPiCalc()+"?("+n.join(",")+")..."};return n}();var Send=function(){n.prototype=new Action;n.prototype.constructor=n;function n(t,e,i){if(!(this instanceof n)){return new n(t,e,i)}this.channel=t;this.args=e||[];this.arity=this.args.length;this.continuation=i}n.prototype.fire=function(){if(this.continuation instanceof Function)return this.continuation();else return undefined};n.prototype.toPiCalc=function(){return this.channel.toPiCalc()+"!("+this.args.map(function(n){return n.toPiCalc()}).join(",")+")..."};return n}();var Alt=function(){function n(t){if(!(this instanceof n)){return new n(t)}this.alts=t||[]}n.prototype.enabled_on=function(n,t){return this.waiting_on(n).length>0};n.prototype.waiting_on=function(n,t){return this.receiving_on(n).concat(this.sending_on(n))};n.prototype.receiving_on=function(n,t){return this.alts.filter(function(e){if(e instanceof Receive){var i=t==undefined||e.arity==t;return e.channel.is(n)&&i}else{return false}})};n.prototype.sending_on=function(n,t){return this.alts.filter(function(e){if(e instanceof Send){var i=t==undefined||e.arity==t;return e.channel.is(n)&&i}else{return false}})};n.prototype.taus=function(){return this.alts.filter(function(n){return n instanceof Tau})};n.prototype.toPiCalc=function(){return"("+this.alts.map(function(n){return n.toPiCalc()}).join(" + ")+")"};return n}();var Zero=undefined;var PiDefs=function(){function n(t){if(!(this instanceof n)){return new n(t)}this.defs=t}n.prototype.unfold=function(n){if(n.proc_name in this.defs){var t=this.defs[n.proc_name];return t.apply(t,n.args)}else return Zero};return n}();var Config=function(){function n(t,e){if(!(this instanceof n)){return new n(t,e)}this.defs=t;this.names_index={};this.init=e;this.nodes=[];this.procsIndex=0;this.epoch=0;this.links=[];this.mergeCalls(e,{x:0,y:0});this.recomputeLinks()}n.prototype.mergeCalls=function(n,e){var i=[],r=[],o=this;if(n==undefined)return{names:[],procs:[]};e=e||{x:0,y:0};n.forEach(function(n){if(n){n.args.forEach(function(n){if(!(n in o.names_index)){o.names_index[n]={refCount:0,age:0};if(e!=undefined){n.x=t(e.x);n.y=t(e.y)}i.push(n)}o.names_index[n].refCount++});var s={call:n,body:o.defs.unfold(n),age:o.epoch};if(e!=undefined){s.x=t(e.x);s.y=t(e.y)}r.push(s)}});this.nodes.unshift.apply(this.nodes,i);this.nodes.push.apply(this.nodes,r);this.procsIndex+=i.length;return{names:i,procs:r}};n.prototype.addCalls=function(n){if(typeof n==="string")n=n.split("|");var t,e=[];for(var i=0;i<n.length;i++){try{var r=n[i].trim().split("[");var o=r[0];var s=r[1].split("]")[0].split(",").map(function(n){return n.trim()});var a=this.getNames();for(var c=0;c<s.length;c++){var u=a.find(function(n){return n.toPiCalc()==s[c]});if(u)s[c]=u;else{u=e.find(function(n){return n.name==s[c]});if(u)s[c]=u;else{s[c]=Channel(s[c]);e.push(s[c])}}}n[i]=ProcCall(o,s)}catch(f){console.log(f);return false}}this.mergeCalls(n,t);this.recomputeLinks();return true};n.prototype.gcNames=function(){for(var n in this.names_index){if(this.names_index[n].refCount<=0)delete this.names_index[n]}var t=0;while(t<this.procsIndex){if(this.nodes[t]in this.names_index){t++}else{this.nodes.splice(t,1);this.procsIndex--}}};n.prototype.redexes=function(){var n=this.procsIndex;var t=[];while(n<this.nodes.length){if(this.nodes[n].body){var e=this.nodes[n];t=t.concat(e.body.taus().map(function(t){return{type:"tau",index:n,action:t,process:e}}))}n++}var i=[];var r=0;while(r<this.procsIndex){var o=[],s=[];var n=this.procsIndex;while(n<this.nodes.length){if(this.nodes[n].body){var e=this.nodes[n];var a=e.body.receiving_on(this.nodes[r]);var c=e.body.sending_on(this.nodes[r]);a.forEach(function(t){s.push({index:n,action:t,process:e})});c.forEach(function(t){o.push({index:n,action:t,process:e})})}n++}var u=0;var f=false;while(u<o.length){var l=0;while(l<s.length){var h=o[u],d=s[l];if(h.index!=d.index&&h.action.arity==d.action.arity){i.push({type:"comm",sender:h,receiver:d});f=true}l++}u++}if(f)this.names_index[this.nodes[r]].age++;else this.names_index[this.nodes[r]].age=0;r++}return t.concat(i)};function t(n){var t=60;return n+Math.random()*t-t/2}function e(n,t){if(n==undefined||!("x"in n&&"y"in n)){return undefined}else if(t==undefined||!("x"in t&&"y"in t)){return{x:n.x,y:n.y}}else{return{x:(n.x+t.x)/2,y:(n.y+t.y)/2}}}function i(n){var t=n.length,e,i;while(t){i=Math.floor(Math.random()*t--);e=n[t];n[t]=n[i];n[i]=e}return n}var r=function(n){return{pick:function(t){i(t);var e=n.epoch+1,r;for(var o=t.length-1;o>=0;o--){var s;if(t[o].type=="tau")s=n.nodes[t[o].index].age;else s=Math.min(n.nodes[t[o].sender.index].age,n.nodes[t[o].receiver.index].age);if(s<=e){e=s;r=o}}if(r!=undefined)return t[r];else return undefined}}};n.prototype.next=function(n){if(n==undefined)n=r(this);var t=this.redexes();if(t.length<=0)return false;var e=n.pick(t);if(e==undefined)return false;this.makeReact(e);return true};n.prototype.makeReact=function(n){if(n.type=="tau"){var t=e(this.nodes[n.index]);var i=n.action.fire();this.removeProc(n.index);this.mergeCalls(i,t)}else{var t=e(this.nodes[n.sender.index],this.nodes[n.receiver.index]);var r=n.sender.action.fire(),o=n.receiver.action.fire(n.sender.action.args);var s=n.sender.index,a=n.receiver.index;this.removeProc(s>a?s:a);this.removeProc(s>a?a:s);this.mergeCalls(r,t);this.mergeCalls(o,t)}this.gcNames();this.recomputeLinks();this.epoch++;return this};n.prototype.removeProc=function(n){if(n>=this.nodes.length||n<this.procsIndex)return false;var t=this.names_index;this.nodes[n].call.args.forEach(function(n){t[n].refCount--});this.nodes.splice(n,1);return true};n.prototype.getNames=function(){return this.nodes.slice(0,this.procsIndex)};n.prototype.getProcs=function(){return this.nodes.slice(this.procsIndex)};n.prototype.recomputeLinks=function(){var n=this.links;n.splice(0,this.links.length);for(var t=this.procsIndex;t<this.nodes.length;t++){var e=this.nodes[t];e.call.args.forEach(function(t){n.push({source:e,target:t})})}};n.prototype.toPiCalc=function(){var n="ν";n+=this.getNames().map(function(n){return n.toPiCalc()}).join(",")+". ";n+=this.getProcs().map(function(n){return n.call.toPiCalc()}).join(" | ");return n};return n}();var PiCalcSimulation=function(){"use strict";var n=d3.scale.category20();var t={nameSize:5,procWidth:18,procHeight:12};var e=/^(.*)_(\d*)$/;function i(e,r,o,s){if(!(this instanceof i)){return new i(e,r,o,s)}var a=r.defs,c=r.init;var u=Config(a,c);this.q=u;s=s||{};for(var f in t){if(t.hasOwnProperty(f)&&!s.hasOwnProperty(f)){s[f]=t[f]}}this.options=s;var l={},h=0;function d(t){if(!l[t]){h++;l[t]=n(h)}return l[t]}for(var p in a.defs){d(p)}o.nodes(u.nodes).links(u.links).start();this.layout=o;var v=e;e=e.append("g");e.append("g").attr("id","links");e.append("g").attr("id","nodes");e.append("g").attr("id","labels");var g=e.select("#links").selectAll(".link");var y=e.select("#nodes").selectAll(".node .name");var m=e.select("#nodes").selectAll(".node .seq");function x(n){if(d3.event.altKey)d3.select(this).classed("fixed",n.fixed=!n.fixed);console.log(d3.select(this).datum())}function C(n){d3.select(this).classed("fixed",n.fixed=true)}this.legend=function(){var n=[];for(var t in l){n.push({name:t,color:l[t]})}return n};this.update=function(){g=g.data(u.links);y=y.data(u.getNames(),function(n){return n.toString()});m=m.data(u.getProcs(),function(n){return n.call.unique});var n=o.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()});g.exit().remove();g.enter().append("line").attr("class","link");y.exit().remove();y.classed("fixed",function(n){return n.fixed});y.enter().append("circle").classed({node:true,name:true}).attr("r",s.nameSize).attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}).on("click",x).call(n).append("title").text(function(n){return n.toPiCalc()});var t=s.procWidth/2,e=s.procHeight/2;m.exit().remove();m.enter().append("rect").attr("class","node seq").attr("width",s.procWidth).attr("height",s.procHeight).attr("x",function(n){n.color=d(n.call.proc_name);return n.x-t}).attr("y",function(n){return n.y-e}).style("fill",function(n){return n.color}).on("click",function(n){console.info(n.call.toPiCalc(),n.x,n.y)}).on("click",x).call(n).append("title").text(function(n){return n.call.toPiCalc()});o.start()};this.update();var w=function(){var n=s.procWidth/2,t=s.procHeight/2;g.attr("x1",function(n){return n.source.x}).attr("y1",function(n){return n.source.y}).attr("x2",function(n){return n.target.x}).attr("y2",function(n){return n.target.y});y.attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y});m.attr("x",function(t){return t.x-n}).attr("y",function(n){return n.y-t})};o.on("tick",w);this.realtime=function(n){o.on("tick",n?w:null)}}i.prototype.next=function(n){if(this.q.next(n)){this.update();return true}else{return false}};return i}();$(function(){var n,t,e;var i,r;var o=function(){var n=[];for(var t=0;t<20;t++){var e=new Channel("r");n.push(ProcCall("S",[e]));var i;i=1+Math.random()*2;for(var r=0;r<i;r++){n.push(ProcCall("C",[e,new Channel("m")]))}i=Math.random()*2-1;for(var r=0;r<i;r++){var o=new Channel("m");n.push(ProcCall("Q",[e,o]));n.push(ProcCall("C1",[e,o]))}i=Math.random()*2-1;for(var r=0;r<i;r++){var o=new Channel("m");var s=new Channel("d");n.push(ProcCall("C1",[e,o]));n.push(ProcCall("A",[o,s]))}}return{defs:PiDefs({S:function(n){return Alt([Receive(n,function(t){var e=new Channel("d");return[ProcCall("A",[t,e]),ProcCall("S",[n])]})])},C:function(n,t){return Alt([Tau(function(){return[ProcCall("Q",[n,t]),ProcCall("C1",[n,t])]})])},Q:function(n,t){return Alt([Send(n,[t])])},C1:function(n,t){return Alt([Receive(t,function(e){return[ProcCall("C",[n,t])]})])},A:function(n,t){return Alt([Send(n,[t])])}}),init:n}}();$("#homedrawing .showoff").html('<svg id="graph"></svg>');n=d3.select("#homedrawing .showoff").select("#graph");d3.select("#homedrawing .showoff").style("display","none");t=d3.layout.force().charge(-400).linkDistance(30).friction(.7);e=PiCalcSimulation(n,o,t);e.delay=500;e.loop=undefined;window.force=t;window.sim=e;function s(){var e=$("#homedrawing svg").parent().innerWidth(),i=$("#homedrawing svg").parent().innerHeight();$("#homedrawing svg").height(i).width(e).attr("width",e).attr("height",i);n.select("g").attr("transform","translate("+e/2+",150)scale(.5,.5)");t.size([e,i]).resume()}$(window).resize(s);var a={pick:function(n){return n[Math.floor(Math.random()*n.length)]}};e.realtime(false);setTimeout(function(){s();t.start();e.update();for(var n=1e3;n>0;--n)t.tick();e.realtime(true);e.next(a);d3.select("#homedrawing .showoff").style("display","block")},10);i=undefined;$(".explain .ctrl").click(function(){if(i===undefined){i=setInterval(function(){c()},7e3);$(this).removeClass("fa-play").addClass("fa-pause")}else{clearInterval(i);i=undefined;$(this).removeClass("fa-pause").addClass("fa-play")}}).click();function c(){e.q.next(a);e.q.next(a);e.q.next(a);e.q.next(a);e.next(a)}});