"use strict";var Channel=function(){function t(e){return this instanceof t?(this.name=e,n[e]||(n[e]=0),this.unique=n[e],void n[e]++):new t(e)}var n={};return t.prototype.toPiCalc=function(){return this.name+"_"+this.unique},t.prototype.is=function(t){return this===t},t.prototype.toString=function(){return this.name+"#"+this.unique},t}(),ProcCall=function(){function t(e,i){return this instanceof t?(this.proc_name=e,this.args=i||[],void(this.unique=n++)):new t(e,i)}var n=0;return t.prototype.toPiCalc=function(){return this.proc_name+"["+this.args.map(function(t){return t.toPiCalc()}).join(",")+"]"},t}(),Action=function(){function t(){return this instanceof t?void 0:new t}return t}(),Tau=function(){function t(n){return this instanceof t?void(this.continuation=n):new t(n)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return"\u03c4..."},t}(),Receive=function(){function t(n,e){return this instanceof t?(this.channel=n,this.continuation=e||function(){},void(this.arity=e.length)):new t(n,e)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(t){return this.continuation instanceof Function?this.continuation.apply(null,t):void 0},t.prototype.toPiCalc=function(){for(var t=[],n=0;n<this.arity;n++)t.push("_");return this.channel.toPiCalc()+"?("+t.join(",")+")..."},t}(),Send=function(){function t(n,e,i){return this instanceof t?(this.channel=n,this.args=e||[],this.arity=this.args.length,void(this.continuation=i)):new t(n,e,i)}return t.prototype=new Action,t.prototype.constructor=t,t.prototype.fire=function(){return this.continuation instanceof Function?this.continuation():void 0},t.prototype.toPiCalc=function(){return this.channel.toPiCalc()+"!("+this.args.map(function(t){return t.toPiCalc()}).join(",")+")..."},t}(),Alt=function(){function t(n){return this instanceof t?void(this.alts=n||[]):new t(n)}return t.prototype.enabled_on=function(t,n){return this.waiting_on(t).length>0},t.prototype.waiting_on=function(t,n){return this.receiving_on(t).concat(this.sending_on(t))},t.prototype.receiving_on=function(t,n){return this.alts.filter(function(e){if(e instanceof Receive){var i=void 0==n||e.arity==n;return e.channel.is(t)&&i}return!1})},t.prototype.sending_on=function(t,n){return this.alts.filter(function(e){if(e instanceof Send){var i=void 0==n||e.arity==n;return e.channel.is(t)&&i}return!1})},t.prototype.taus=function(){return this.alts.filter(function(t){return t instanceof Tau})},t.prototype.toPiCalc=function(){return"("+this.alts.map(function(t){return t.toPiCalc()}).join(" + ")+")"},t}(),Zero=void 0,PiDefs=function(){function t(n){return this instanceof t?void(this.defs=n):new t(n)}return t.prototype.unfold=function(t){if(t.proc_name in this.defs){var n=this.defs[t.proc_name];return n.apply(n,t.args)}return Zero},t}(),Config=function(){function t(n,e){return this instanceof t?(this.defs=n,this.names_index={},this.init=e,this.nodes=[],this.procsIndex=0,this.epoch=0,this.links=[],this.mergeCalls(e,{x:0,y:0}),void this.recomputeLinks()):new t(n,e)}function n(t){var n=60;return t+Math.random()*n-n/2}function e(t,n){return void 0!=t&&"x"in t&&"y"in t?void 0!=n&&"x"in n&&"y"in n?{x:(t.x+n.x)/2,y:(t.y+n.y)/2}:{x:t.x,y:t.y}:void 0}function i(t){for(var n=t.length,e,i;n;)i=Math.floor(Math.random()*n--),e=t[n],t[n]=t[i],t[i]=e;return t}t.prototype.mergeCalls=function(t,e){var i=[],r=[],o=this;return void 0==t?{names:[],procs:[]}:(e=e||{x:0,y:0},t.forEach(function(t){if(t){t.args.forEach(function(t){t in o.names_index||(o.names_index[t]={refCount:0,age:0},void 0!=e&&(t.x=n(e.x),t.y=n(e.y)),i.push(t)),o.names_index[t].refCount++});var s={call:t,body:o.defs.unfold(t),age:o.epoch};void 0!=e&&(s.x=n(e.x),s.y=n(e.y)),r.push(s)}}),this.nodes.unshift.apply(this.nodes,i),this.nodes.push.apply(this.nodes,r),this.procsIndex+=i.length,{names:i,procs:r})},t.prototype.addCalls=function(t){"string"==typeof t&&(t=t.split("|"));for(var n,e=[],i=0;i<t.length;i++)try{for(var r=t[i].trim().split("["),o=r[0],s=r[1].split("]")[0].split(",").map(function(t){return t.trim()}),a=this.getNames(),c=0;c<s.length;c++){var u=a.find(function(t){return t.toPiCalc()==s[c]});u?s[c]=u:(u=e.find(function(t){return t.name==s[c]}),u?s[c]=u:(s[c]=Channel(s[c]),e.push(s[c])))}t[i]=ProcCall(o,s)}catch(h){return console.log(h),!1}return this.mergeCalls(t,n),this.recomputeLinks(),!0},t.prototype.gcNames=function(){for(var t in this.names_index)this.names_index[t].refCount<=0&&delete this.names_index[t];for(var n=0;n<this.procsIndex;)this.nodes[n]in this.names_index?n++:(this.nodes.splice(n,1),this.procsIndex--)},t.prototype.redexes=function(){for(var t=this.procsIndex,n=[];t<this.nodes.length;){if(this.nodes[t].body){var e=this.nodes[t];n=n.concat(e.body.taus().map(function(n){return{type:"tau",index:t,action:n,process:e}}))}t++}for(var i=[],r=0;r<this.procsIndex;){for(var o=[],s=[],t=this.procsIndex;t<this.nodes.length;){if(this.nodes[t].body){var e=this.nodes[t],a=e.body.receiving_on(this.nodes[r]),c=e.body.sending_on(this.nodes[r]);a.forEach(function(n){s.push({index:t,action:n,process:e})}),c.forEach(function(n){o.push({index:t,action:n,process:e})})}t++}for(var u=0,h=!1;u<o.length;){for(var l=0;l<s.length;){var f=o[u],d=s[l];f.index!=d.index&&f.action.arity==d.action.arity&&(i.push({type:"comm",sender:f,receiver:d}),h=!0),l++}u++}h?this.names_index[this.nodes[r]].age++:this.names_index[this.nodes[r]].age=0,r++}return n.concat(i)};var r=function(t){return{pick:function(n){i(n);for(var e=t.epoch+1,r,o=n.length-1;o>=0;o--){var s;s="tau"==n[o].type?t.nodes[n[o].index].age:Math.min(t.nodes[n[o].sender.index].age,t.nodes[n[o].receiver.index].age),e>=s&&(e=s,r=o)}return void 0!=r?n[r]:void 0}}};return t.prototype.next=function(t){void 0==t&&(t=r(this));var n=this.redexes();if(n.length<=0)return!1;var e=t.pick(n);return void 0==e?!1:(this.makeReact(e),!0)},t.prototype.makeReact=function(t){if("tau"==t.type){var n=e(this.nodes[t.index]),i=t.action.fire();this.removeProc(t.index),this.mergeCalls(i,n)}else{var n=e(this.nodes[t.sender.index],this.nodes[t.receiver.index]),r=t.sender.action.fire(),o=t.receiver.action.fire(t.sender.action.args),s=t.sender.index,a=t.receiver.index;this.removeProc(s>a?s:a),this.removeProc(s>a?a:s),this.mergeCalls(r,n),this.mergeCalls(o,n)}return this.gcNames(),this.recomputeLinks(),this.epoch++,this},t.prototype.removeProc=function(t){if(t>=this.nodes.length||t<this.procsIndex)return!1;var n=this.names_index;return this.nodes[t].call.args.forEach(function(t){n[t].refCount--}),this.nodes.splice(t,1),!0},t.prototype.getNames=function(){return this.nodes.slice(0,this.procsIndex)},t.prototype.getProcs=function(){return this.nodes.slice(this.procsIndex)},t.prototype.recomputeLinks=function(){var t=this.links;t.splice(0,this.links.length);for(var n=this.procsIndex;n<this.nodes.length;n++){var e=this.nodes[n];e.call.args.forEach(function(n){t.push({source:e,target:n})})}},t.prototype.toPiCalc=function(){var t="\u03bd";return t+=this.getNames().map(function(t){return t.toPiCalc()}).join(",")+". ",t+=this.getProcs().map(function(t){return t.call.toPiCalc()}).join(" | ")},t}(),PiCalcSimulation=function(){function t(i,r,o,s){function a(t){return p[t]||(v++,p[t]=n(v)),p[t]}function c(t){d3.event.altKey&&d3.select(this).classed("fixed",t.fixed=!t.fixed)}function u(t){d3.select(this).classed("fixed",t.fixed=!0)}if(!(this instanceof t))return new t(i,r,o,s);var h=r.defs,l=r.init,f=Config(h,l);this.q=f,s=s||{};for(var d in e)e.hasOwnProperty(d)&&!s.hasOwnProperty(d)&&(s[d]=e[d]);this.options=s;var p={},v=0;for(var g in h.defs)a(g);o.nodes(f.nodes).links(f.links).start(),this.layout=o;var y=i;i=i.append("g"),i.append("g").attr("id","links"),i.append("g").attr("id","nodes"),i.append("g").attr("id","labels");var m=i.select("#links").selectAll(".link"),x=i.select("#nodes").selectAll(".node .name"),C=i.select("#nodes").selectAll(".node .seq");this.legend=function(){var t=[];for(var n in p)t.push({name:n,color:p[n]});return t},this.update=function(){m=m.data(f.links),x=x.data(f.getNames(),function(t){return t.toString()}),C=C.data(f.getProcs(),function(t){return t.call.unique});var t=o.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()});m.exit().remove(),m.enter().append("line").attr("class","link"),x.exit().remove(),x.classed("fixed",function(t){return t.fixed}),x.enter().append("circle").classed({node:!0,name:!0}).attr("r",s.nameSize).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).on("click",c).call(t);var n=s.procWidth/2,e=s.procHeight/2;C.exit().remove(),C.enter().append("rect").attr("class","node seq").attr("width",s.procWidth).attr("height",s.procHeight).attr("x",function(t){return t.color=a(t.call.proc_name),t.x-n}).attr("y",function(t){return t.y-e}).style("fill",function(t){return t.color}).on("click",function(t){console.info(t.call.toPiCalc(),t.x,t.y)}).on("click",c).call(t),o.start()},this.update();var w=function(){var t=s.procWidth/2,n=s.procHeight/2;m.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),x.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}),C.attr("x",function(n){return n.x-t}).attr("y",function(t){return t.y-n})};o.on("tick",w),this.realtime=function(t){o.on("tick",t?w:null)}}var n=d3.scale.category20(),e={nameSize:5,procWidth:18,procHeight:12},i=/^(.*)_(\d*)$/;return t.prototype.next=function(t){return this.q.next(t)?(this.update(),!0):!1},t}();$(function(){function t(){var t=$("#homedrawing svg").parent().innerWidth(),n=$("#homedrawing svg").parent().innerHeight();$("#homedrawing svg").height(n).width(t).attr("width",t).attr("height",n),e.select("g").attr("transform","translate("+t/2+",150)scale(.5,.5)"),i.size([t,n]).resume()}function n(){r.q.next(c),r.q.next(c),r.q.next(c),r.q.next(c),r.next(c)}var e,i,r,o,s,a=function(){for(var t=[],n=0;20>n;n++){var e=new Channel("r");t.push(ProcCall("S",[e]));var i;i=1+2*Math.random();for(var r=0;i>r;r++)t.push(ProcCall("C",[e,new Channel("m")]));i=2*Math.random()-1;for(var r=0;i>r;r++){var o=new Channel("m");t.push(ProcCall("Q",[e,o])),t.push(ProcCall("C1",[e,o]))}i=2*Math.random()-1;for(var r=0;i>r;r++){var o=new Channel("m"),s=new Channel("d");t.push(ProcCall("C1",[e,o])),t.push(ProcCall("A",[o,s]))}}return{defs:PiDefs({S:function(t){return Alt([Receive(t,function(n){var e=new Channel("d");return[ProcCall("A",[n,e]),ProcCall("S",[t])]})])},C:function(t,n){return Alt([Tau(function(){return[ProcCall("Q",[t,n]),ProcCall("C1",[t,n])]})])},Q:function(t,n){return Alt([Send(t,[n])])},C1:function(t,n){return Alt([Receive(n,function(e){return[ProcCall("C",[t,n])]})])},A:function(t,n){return Alt([Send(t,[n])])}}),init:t}}();$("#homedrawing .showoff").html('<svg id="graph"></svg>'),e=d3.select("#homedrawing .showoff").select("#graph"),d3.select("#homedrawing .showoff").attr("title","Drag me!").style("display","none"),i=d3.layout.force().charge(-400).linkDistance(30).friction(.7),r=PiCalcSimulation(e,a,i),r.delay=500,r.loop=void 0,window.force=i,window.sim=r,$(window).resize(t);var c={pick:function(t){return t[Math.floor(Math.random()*t.length)]}};r.realtime(!1),setTimeout(function(){t(),i.start(),r.update();for(var n=1e3;n>0;--n)i.tick();r.realtime(!0),r.next(c),d3.select("#homedrawing .showoff").style("display","block")},10),o=void 0,$(".explain .ctrl").click(function(){void 0===o?(o=setInterval(function(){n()},7e3),$(this).removeClass("fa-play").addClass("fa-pause")):(clearInterval(o),o=void 0,$(this).removeClass("fa-pause").addClass("fa-play"))}).click()});