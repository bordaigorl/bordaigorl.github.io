"use strict";var Channel=function(){var next_id={};function Channel(name){if(!(this instanceof Channel)){return new Channel(name)}this.name=name;if(!next_id[name]){next_id[name]=0}this.unique=next_id[name];next_id[name]++}Channel.prototype.toPiCalc=function(){return this.name+"_"+this.unique};Channel.prototype.is=function(that){return this===that};Channel.prototype.toString=function(){return this.name+"#"+this.unique};return Channel}();var ProcCall=function(){var next_proc=0;function ProcCall(name,args){if(!(this instanceof ProcCall)){return new ProcCall(name,args)}this.proc_name=name;this.args=args||[];this.unique=next_proc++}ProcCall.prototype.toPiCalc=function(){return this.proc_name+"["+this.args.map(function(x){return x.toPiCalc()}).join(",")+"]"};return ProcCall}();var Action=function(){function Action(){if(!(this instanceof Action)){return new Action}}return Action}();var Tau=function(){Tau.prototype=new Action;Tau.prototype.constructor=Tau;function Tau(cont){if(!(this instanceof Tau)){return new Tau(cont)}this.continuation=cont}Tau.prototype.fire=function(){if(this.continuation instanceof Function)return this.continuation();else return undefined};Tau.prototype.toPiCalc=function(){return"τ..."};return Tau}();var Receive=function(){Receive.prototype=new Action;Receive.prototype.constructor=Receive;function Receive(ch,cont){if(!(this instanceof Receive)){return new Receive(ch,cont)}this.channel=ch;this.continuation=cont||function(){};this.arity=cont.length}Receive.prototype.fire=function(args){if(this.continuation instanceof Function)return this.continuation.apply(null,args);else return undefined};Receive.prototype.toPiCalc=function(){var args=[];for(var i=0;i<this.arity;i++){args.push("_")}return this.channel.toPiCalc()+"?("+args.join(",")+")..."};return Receive}();var Send=function(){Send.prototype=new Action;Send.prototype.constructor=Send;function Send(ch,args,cont){if(!(this instanceof Send)){return new Send(ch,args,cont)}this.channel=ch;this.args=args||[];this.arity=this.args.length;this.continuation=cont}Send.prototype.fire=function(){if(this.continuation instanceof Function)return this.continuation();else return undefined};Send.prototype.toPiCalc=function(){return this.channel.toPiCalc()+"!("+this.args.map(function(x){return x.toPiCalc()}).join(",")+")..."};return Send}();var Alt=function(){function Alt(alts){if(!(this instanceof Alt)){return new Alt(alts)}this.alts=alts||[]}Alt.prototype.enabled_on=function(ch,ar){return this.waiting_on(ch).length>0};Alt.prototype.waiting_on=function(ch,ar){return this.receiving_on(ch).concat(this.sending_on(ch))};Alt.prototype.receiving_on=function(ch,ar){return this.alts.filter(function(a){if(a instanceof Receive){var arity_matches=ar==undefined||a.arity==ar;return a.channel.is(ch)&&arity_matches}else{return false}})};Alt.prototype.sending_on=function(ch,ar){return this.alts.filter(function(a){if(a instanceof Send){var arity_matches=ar==undefined||a.arity==ar;return a.channel.is(ch)&&arity_matches}else{return false}})};Alt.prototype.taus=function(){return this.alts.filter(function(a){return a instanceof Tau})};Alt.prototype.toPiCalc=function(){return"("+this.alts.map(function(x){return x.toPiCalc()}).join(" + ")+")"};return Alt}();var Zero=undefined;var PiDefs=function(){function PiDefs(defs){if(!(this instanceof PiDefs)){return new PiDefs(defs)}this.defs=defs}PiDefs.prototype.unfold=function(call){if(call.proc_name in this.defs){var def=this.defs[call.proc_name];return def.apply(def,call.args)}else return Zero};return PiDefs}();var Config=function(){function Config(defs,init){if(!(this instanceof Config)){return new Config(defs,init)}this.defs=defs;this.names_index={};this.init=init;this.nodes=[];this.procsIndex=0;this.epoch=0;this.links=[];this.mergeCalls(init,{x:0,y:0});this.recomputeLinks()}Config.prototype.mergeCalls=function(calls,origin){var names=[],procs=[],me=this;if(calls==undefined)return{names:[],procs:[]};origin=origin||{x:0,y:0};calls.forEach(function(c){if(c){c.args.forEach(function(n){if(!(n in me.names_index)){me.names_index[n]={refCount:0,age:0};if(origin!=undefined){n.x=perturbate(origin.x);n.y=perturbate(origin.y)}names.push(n)}me.names_index[n].refCount++});var p={call:c,body:me.defs.unfold(c),age:me.epoch};if(origin!=undefined){p.x=perturbate(origin.x);p.y=perturbate(origin.y)}procs.push(p)}});this.nodes.unshift.apply(this.nodes,names);this.nodes.push.apply(this.nodes,procs);this.procsIndex+=names.length;return{names:names,procs:procs}};Config.prototype.addCalls=function(calls){if(typeof calls==="string")calls=calls.split("|");var origin,newnames=[];for(var i=0;i<calls.length;i++){try{var parse=calls[i].trim().split("[");var pid=parse[0];var args=parse[1].split("]")[0].split(",").map(function(x){return x.trim()});var names=this.getNames();for(var j=0;j<args.length;j++){var found=names.find(function(n){return n.toPiCalc()==args[j]});if(found)args[j]=found;else{found=newnames.find(function(n){return n.name==args[j]});if(found)args[j]=found;else{args[j]=Channel(args[j]);newnames.push(args[j])}}}calls[i]=ProcCall(pid,args)}catch(err){console.log(err);return false}}this.mergeCalls(calls,origin);this.recomputeLinks();return true};Config.prototype.gcNames=function(){for(var n in this.names_index){if(this.names_index[n].refCount<=0)delete this.names_index[n]}var i=0;while(i<this.procsIndex){if(this.nodes[i]in this.names_index){i++}else{this.nodes.splice(i,1);this.procsIndex--}}};Config.prototype.redexes=function(){var p=this.procsIndex;var taus=[];while(p<this.nodes.length){if(this.nodes[p].body){var node=this.nodes[p];taus=taus.concat(node.body.taus().map(function(x){return{type:"tau",index:p,action:x,process:node}}))}p++}var commun=[];var n=0;while(n<this.procsIndex){var senders=[],receivers=[];var p=this.procsIndex;while(p<this.nodes.length){if(this.nodes[p].body){var node=this.nodes[p];var rec=node.body.receiving_on(this.nodes[n]);var snd=node.body.sending_on(this.nodes[n]);rec.forEach(function(a){receivers.push({index:p,action:a,process:node})});snd.forEach(function(a){senders.push({index:p,action:a,process:node})})}p++}var s=0;var enabled=false;while(s<senders.length){var r=0;while(r<receivers.length){var sender=senders[s],receiver=receivers[r];if(sender.index!=receiver.index&&sender.action.arity==receiver.action.arity){commun.push({type:"comm",sender:sender,receiver:receiver});enabled=true}r++}s++}if(enabled)this.names_index[this.nodes[n]].age++;else this.names_index[this.nodes[n]].age=0;n++}return taus.concat(commun)};function perturbate(x){var r=60;return x+Math.random()*r-r/2}function pos(obj,obj2){if(obj==undefined||!("x"in obj&&"y"in obj)){return undefined}else if(obj2==undefined||!("x"in obj2&&"y"in obj2)){return{x:obj.x,y:obj.y}}else{return{x:(obj.x+obj2.x)/2,y:(obj.y+obj2.y)/2}}}function shuffle(array){var m=array.length,t,i;while(m){i=Math.floor(Math.random()*m--);t=array[m];array[m]=array[i];array[i]=t}return array}var defaultStrategy=function(cnf){return{pick:function(x){shuffle(x);var m=cnf.epoch+1,r;for(var i=x.length-1;i>=0;i--){var age;if(x[i].type=="tau")age=cnf.nodes[x[i].index].age;else age=Math.min(cnf.nodes[x[i].sender.index].age,cnf.nodes[x[i].receiver.index].age);if(age<=m){m=age;r=i}}if(r!=undefined)return x[r];else return undefined}}};Config.prototype.next=function(strategy){if(strategy==undefined)strategy=defaultStrategy(this);var redexes=this.redexes();if(redexes.length<=0)return false;var redex=strategy.pick(redexes);if(redex==undefined)return false;this.makeReact(redex);return true};Config.prototype.makeReact=function(redex){if(redex.type=="tau"){var xy=pos(this.nodes[redex.index]);var reactum=redex.action.fire();this.removeProc(redex.index);this.mergeCalls(reactum,xy)}else{var xy=pos(this.nodes[redex.sender.index],this.nodes[redex.receiver.index]);var reactum1=redex.sender.action.fire(),reactum2=redex.receiver.action.fire(redex.sender.action.args);var a=redex.sender.index,b=redex.receiver.index;this.removeProc(a>b?a:b);this.removeProc(a>b?b:a);this.mergeCalls(reactum1,xy);this.mergeCalls(reactum2,xy)}this.gcNames();this.recomputeLinks();this.epoch++;return this};Config.prototype.removeProc=function(index){if(index>=this.nodes.length||index<this.procsIndex)return false;var names_index=this.names_index;this.nodes[index].call.args.forEach(function(x){names_index[x].refCount--});this.nodes.splice(index,1);return true};Config.prototype.getNames=function(){return this.nodes.slice(0,this.procsIndex)};Config.prototype.getProcs=function(){return this.nodes.slice(this.procsIndex)};Config.prototype.recomputeLinks=function(){var links=this.links;links.splice(0,this.links.length);for(var i=this.procsIndex;i<this.nodes.length;i++){var p=this.nodes[i];p.call.args.forEach(function(x){links.push({source:p,target:x})})}};Config.prototype.toPiCalc=function(){var s="ν";s+=this.getNames().map(function(x){return x.toPiCalc()}).join(",")+". ";s+=this.getProcs().map(function(x){return x.call.toPiCalc()}).join(" | ");return s};return Config}();var PiCalcSimulation=function(){"use strict";var colorcat=d3.scale.category20();var defaults={nameSize:5,procWidth:18,procHeight:12};var NAME_REGEX=/^(.*)_(\d*)$/;function PiCalcSimulation(svg,prog,force,options){if(!(this instanceof PiCalcSimulation)){return new PiCalcSimulation(svg,prog,force,options)}var defs=prog.defs,init=prog.init;var q=Config(defs,init);this.q=q;options=options||{};for(var prop in defaults){if(defaults.hasOwnProperty(prop)&&!options.hasOwnProperty(prop)){options[prop]=defaults[prop]}}this.options=options;var colormap={},next_cat=0;function color(i){if(!colormap[i]){next_cat++;colormap[i]=colorcat(next_cat)}return colormap[i]}for(var k in defs.defs){color(k)}force.nodes(q.nodes).links(q.links).start();this.layout=force;var container=svg;svg=svg.append("g");svg.append("g").attr("id","links");svg.append("g").attr("id","nodes");svg.append("g").attr("id","labels");var link=svg.select("#links").selectAll(".link");var names=svg.select("#nodes").selectAll(".node .name");var seqs=svg.select("#nodes").selectAll(".node .seq");function toggleFixed(d){if(d3.event.altKey)d3.select(this).classed("fixed",d.fixed=!d.fixed)}function dragstart(d){d3.select(this).classed("fixed",d.fixed=true)}this.legend=function(){var leg=[];for(var n in colormap){leg.push({name:n,color:colormap[n]})}return leg};this.update=function(){link=link.data(q.links);names=names.data(q.getNames(),function(d){return d.toString()});seqs=seqs.data(q.getProcs(),function(d){return d.call.unique});var drag=force.drag().on("dragstart",function(){d3.event.sourceEvent.stopPropagation()});link.exit().remove();link.enter().append("line").attr("class","link");names.exit().remove();names.classed("fixed",function(d){return d.fixed});names.enter().append("circle").classed({node:true,name:true}).attr("r",options.nameSize).attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).on("click",toggleFixed).call(drag).append("title").text(function(d){return d.toPiCalc()});var seqShiftX=options.procWidth/2,seqShiftY=options.procHeight/2;seqs.exit().remove();seqs.enter().append("rect").attr("class","node seq").attr("width",options.procWidth).attr("height",options.procHeight).attr("x",function(d){d.color=color(d.call.proc_name);return d.x-seqShiftX}).attr("y",function(d){return d.y-seqShiftY}).style("fill",function(d){return d.color}).on("click",function(d){console.info(d.call.toPiCalc(),d.x,d.y)}).on("click",toggleFixed).call(drag).append("title").text(function(d){return d.call.toPiCalc()});force.start()};this.update();var tick=function(){var seqShiftX=options.procWidth/2,seqShiftY=options.procHeight/2;link.attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y});names.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y});seqs.attr("x",function(d){return d.x-seqShiftX}).attr("y",function(d){return d.y-seqShiftY})};force.on("tick",tick);this.realtime=function(flag){force.on("tick",flag?tick:null)}}PiCalcSimulation.prototype.next=function(s){if(this.q.next(s)){this.update();return true}else{return false}};return PiCalcSimulation}();$(function(){var svg,force,sim;var t,n;var system=function(){var initial=[];for(var i=0;i<20;i++){var req=new Channel("r");initial.push(ProcCall("S",[req]));var cl;cl=1+Math.random()*2;for(var j=0;j<cl;j++){initial.push(ProcCall("C",[req,new Channel("m")]))}cl=Math.random()*2-1;for(var j=0;j<cl;j++){var m=new Channel("m");initial.push(ProcCall("Q",[req,m]));initial.push(ProcCall("C1",[req,m]))}cl=Math.random()*2-1;for(var j=0;j<cl;j++){var m=new Channel("m");var ok=new Channel("d");initial.push(ProcCall("C1",[req,m]));initial.push(ProcCall("A",[m,ok]))}}return{defs:PiDefs({S:function(r){return Alt([Receive(r,function(x){var ok=new Channel("d");return[ProcCall("A",[x,ok]),ProcCall("S",[r])]})])},C:function(r,m){return Alt([Tau(function(){return[ProcCall("Q",[r,m]),ProcCall("C1",[r,m])]})])},Q:function(r,a){return Alt([Send(r,[a])])},C1:function(r,m){return Alt([Receive(m,function(x){return[ProcCall("C",[r,m])]})])},A:function(a,ok){return Alt([Send(a,[ok])])}}),init:initial}}();$("#homedrawing .showoff").html('<svg id="graph"></svg>');svg=d3.select("#homedrawing .showoff").select("#graph");d3.select("#homedrawing .showoff").style("display","none");force=d3.layout.force().charge(-400).linkDistance(30).friction(.7);sim=PiCalcSimulation(svg,system,force);sim.delay=500;sim.loop=undefined;window.force=force;window.sim=sim;function resizeCanvas(){var width=$("#homedrawing svg").parent().innerWidth(),height=$("#homedrawing svg").parent().innerHeight();$("#homedrawing svg").height(height).width(width).attr("width",width).attr("height",height);svg.select("g").attr("transform","translate("+width/2+",150)scale(.5,.5)");force.size([width,height]).resume()}$(window).resize(resizeCanvas);var strat={pick:function(x){return x[Math.floor(Math.random()*x.length)]}};sim.realtime(false);setTimeout(function(){resizeCanvas();force.start();sim.update();for(var i=1e3;i>0;--i)force.tick();sim.realtime(true);sim.next(strat);d3.select("#homedrawing .showoff").style("display","block")},10);t=undefined;$(".explain .ctrl").click(function(){if(t===undefined){t=setInterval(function(){the_force_awakens()},7e3);$(this).removeClass("fa-play").addClass("fa-pause")}else{clearInterval(t);t=undefined;$(this).removeClass("fa-pause").addClass("fa-play")}}).click();function the_force_awakens(){sim.q.next(strat);sim.q.next(strat);sim.q.next(strat);sim.q.next(strat);sim.next(strat)}});